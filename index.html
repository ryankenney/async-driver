<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Jasync-driver by ryankenney</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/ryankenney/jasync-driver">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/ryankenney/jasync-driver/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/ryankenney/jasync-driver/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Jasync-driver</h1>
          <p>Treat asynchrouns Java actions as synchronous. Don&#39;t just chain actions together, write standard delarative logic without callbacks!</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/ryankenney">ryankenney</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <p>No dependencies. 100% pure Java. Works with GWT. Tastes great. Less filling.</p>

<h2>
<a id="contents" class="anchor" href="#contents" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contents</h2>

<ul>
<li><a href="#the-problem">The Problem</a></li>
<li><a href="#jasync-driver-example">jasync-driver Example</a></li>
<li><a href="#critical-rules-of-the-road">Critical Rules of the Road</a></li>
<li><a href="#how-it-works">How it Works</a></li>
<li><a href="#faq">FAQ</a></li>
</ul>

<h2>
<a id="the-problem" class="anchor" href="#the-problem" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Problem</h2>

<p>Imagine that you want to model this logic in a java gui:</p>

<ul>
<li>On User Click

<ul>
<li>Read User Permissions</li>
<li>If User Has "edit" Permissions

<ul>
<li>Prompt User for New Value</li>
<li>Store New Value</li>
<li>If Store Fails

<ul>
<li>Notify User of Failure</li>
</ul>
</li>
</ul>
</li>
<li>If User Does Not Have "edit" Permissions

<ul>
<li>Notify User of Permissions Issue</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>Because many of these actions are asynchronous (they require a server or user response before resuming), you can end up with code that looks like this:</p>

<div class="highlight highlight-source-java"><pre>    <span class="pl-k">public</span> <span class="pl-k">void</span> onUserClick() {
        readUserPermissions();
    }

    <span class="pl-k">void</span> readUserPermissions() {
        webServer<span class="pl-k">.</span>readUserPermissions(user, <span class="pl-k">new</span> <span class="pl-k">ReturnCallback&lt;<span class="pl-smi">Permissions</span>&gt;</span> () {
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">handleResult</span>(<span class="pl-smi">Permissions</span> <span class="pl-v">permissions</span>) {
                <span class="pl-k">if</span> (permissions<span class="pl-k">.</span>permissions<span class="pl-k">.</span>contains(<span class="pl-s"><span class="pl-pds">"</span>edit<span class="pl-pds">"</span></span>)) {
                    promptUserForNewValue();
                } <span class="pl-k">else</span> {
                    notifyPermissionsError();
                }
            }
        });
    }

    <span class="pl-k">void</span> notifyPermissionsError() {
        userInterface<span class="pl-k">.</span>showError(<span class="pl-s"><span class="pl-pds">"</span>User does not have edit permission<span class="pl-pds">"</span></span>);
    }

    <span class="pl-k">void</span> promptUserForNewValue() {
        userInterface<span class="pl-k">.</span>promptForNewValue(<span class="pl-k">new</span> <span class="pl-k">ReturnCallback&lt;<span class="pl-smi">String</span>&gt;</span> () {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">handleResult</span>(<span class="pl-smi">String</span> <span class="pl-v">result</span>) {
                updateStoredValue(result);
            }
        });
    }

    <span class="pl-k">void</span> updateStoredValue(<span class="pl-smi">String</span> value) {
        webServer<span class="pl-k">.</span>storeValue(value, <span class="pl-k">new</span> <span class="pl-k">ReturnCallback&lt;<span class="pl-smi">Status</span>&gt;</span> () {
            <span class="pl-k">@Override</span>
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">handleResult</span>(<span class="pl-smi">Status</span> <span class="pl-v">result</span>) {
                <span class="pl-k">if</span> (result <span class="pl-k">!=</span> <span class="pl-smi">Status</span><span class="pl-c1"><span class="pl-k">.</span>OK</span>) {
                    notifyStoreError();
                }
            }
        });
    }

    <span class="pl-k">void</span> notifyStoreError() {
        userInterface<span class="pl-k">.</span>showError(<span class="pl-s"><span class="pl-pds">"</span>Store action failed<span class="pl-pds">"</span></span>);
    }</pre></div>

<p>Where did that nice little block of conditional logic go? It got smeared across all of the callback methods necesssary to string the asynchronous actions together.</p>

<h2>
<a id="jasync-driver-example" class="anchor" href="#jasync-driver-example" aria-hidden="true"><span class="octicon octicon-link"></span></a>jasync-driver Example</h2>

<p>With jasync-driver, we can define the logic block as if everything is synchronous.
For example, this models the logic above:</p>

<div class="highlight highlight-source-java"><pre>    <span class="pl-k">final</span> <span class="pl-smi">JasyncDriver</span> driver <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JasyncDriver</span>();
    driver<span class="pl-k">.</span>execute(<span class="pl-k">new</span> <span class="pl-smi">DriverBody</span>() {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>() {
            <span class="pl-smi">Permissions</span> permissions <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(readUserPermissions, user);
            <span class="pl-k">if</span> (<span class="pl-k">!</span>driver<span class="pl-k">.</span>execute(hasEditPermission, permissions)) {
                driver<span class="pl-k">.</span>execute(notifyPermissionsError);
            } <span class="pl-k">else</span> {
                <span class="pl-smi">String</span> userInput <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(promptUserForNewValue);
                <span class="pl-smi">Status</span> storeStatus <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(updateStoredValue, userInput);
                <span class="pl-k">if</span> (storeStatus <span class="pl-k">!=</span> <span class="pl-smi">Status</span><span class="pl-c1"><span class="pl-k">.</span>OK</span>) {
                    driver<span class="pl-k">.</span>execute(notifyStoreError);
                }
            }
        }
    });</pre></div>

<p>From here, you have to wrap each of the asynchronous actions in a Task object,
but the resulting code is arguably much more legible. Here is a more complete example:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">WebServer</span> webServer;
<span class="pl-smi">UserInterface</span> userInterface;
<span class="pl-smi">User</span> user;

<span class="pl-k">public</span> <span class="pl-k">void</span> onUserClick() {

    <span class="pl-k">final</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">User</span>,<span class="pl-smi">Permissions</span>&gt;</span> readUserPermissions <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">User</span>,<span class="pl-smi">Permissions</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>(<span class="pl-k">final</span> <span class="pl-smi">User</span> <span class="pl-v">user</span>, <span class="pl-k">final</span> <span class="pl-k">ResultHandler&lt;<span class="pl-smi">Permissions</span>&gt;</span> <span class="pl-v">resultHandler</span>) {
            webServer<span class="pl-k">.</span>readUserPermissions(user, <span class="pl-k">new</span> <span class="pl-k">ReturnCallback&lt;<span class="pl-smi">Permissions</span>&gt;</span> () {
                <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">handleResult</span>(<span class="pl-smi">Permissions</span> <span class="pl-v">result</span>) {
                    resultHandler<span class="pl-k">.</span>reportComplete(result);
                }
            });
        }
    };

    <span class="pl-k">final</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Permissions</span>,<span class="pl-smi">Boolean</span>&gt;</span> hasEditPermission <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Permissions</span>,<span class="pl-smi">Boolean</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-smi">Boolean</span> <span class="pl-en">run</span>(<span class="pl-smi">Permissions</span> <span class="pl-v">permissions</span>) {
            <span class="pl-k">return</span> permissions<span class="pl-k">.</span>permissions<span class="pl-k">.</span>contains(<span class="pl-s"><span class="pl-pds">"</span>edit<span class="pl-pds">"</span></span>);
        }
    };

    <span class="pl-k">final</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Void</span>&gt;</span> notifyPermissionsError <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Void</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-smi">Void</span> <span class="pl-en">run</span>(<span class="pl-smi">Void</span> <span class="pl-v">arg</span>) {
            userInterface<span class="pl-k">.</span>showError(<span class="pl-s"><span class="pl-pds">"</span>User does not have edit permission<span class="pl-pds">"</span></span>);
            <span class="pl-k">return</span> <span class="pl-c1">null</span>;
        }
    };

    <span class="pl-k">final</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">String</span>&gt;</span> promptUserForNewValue <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">String</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>(<span class="pl-k">final</span> <span class="pl-smi">Void</span>  <span class="pl-v">arg</span>, <span class="pl-k">final</span> <span class="pl-k">ResultHandler&lt;<span class="pl-smi">String</span>&gt;</span> <span class="pl-v">resultHandler</span>) {
            userInterface<span class="pl-k">.</span>promptForNewValue(<span class="pl-k">new</span> <span class="pl-k">ReturnCallback&lt;<span class="pl-smi">String</span>&gt;</span> () {
                <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">handleResult</span>(<span class="pl-smi">String</span> <span class="pl-v">result</span>) {
                    resultHandler<span class="pl-k">.</span>reportComplete(result);
                }
            });
        }
    };

    <span class="pl-k">final</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">String</span>,<span class="pl-smi">Status</span>&gt;</span> updateStoredValue <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">String</span>,<span class="pl-smi">Status</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>(<span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-v">value</span>, <span class="pl-k">final</span> <span class="pl-k">ResultHandler&lt;<span class="pl-smi">Status</span>&gt;</span> <span class="pl-v">resultHandler</span>) {
            webServer<span class="pl-k">.</span>storeValue(value, <span class="pl-k">new</span> <span class="pl-k">ReturnCallback&lt;<span class="pl-smi">Status</span>&gt;</span> () {
                <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">handleResult</span>(<span class="pl-smi">Status</span> <span class="pl-v">result</span>) {
                    resultHandler<span class="pl-k">.</span>reportComplete(result);
                }
            });
        }
    };

    <span class="pl-k">final</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Void</span>&gt;</span> notifyStoreError <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Void</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-smi">Void</span> <span class="pl-en">run</span>(<span class="pl-smi">Void</span> <span class="pl-v">arg</span>) {
            userInterface<span class="pl-k">.</span>showError(<span class="pl-s"><span class="pl-pds">"</span>Store action failed<span class="pl-pds">"</span></span>);
            <span class="pl-k">return</span> <span class="pl-c1">null</span>;
        }
    };

    <span class="pl-k">final</span> <span class="pl-smi">JasyncDriver</span> driver <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JasyncDriver</span>();
    driver<span class="pl-k">.</span>execute(<span class="pl-k">new</span> <span class="pl-smi">DriverBody</span>() {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>() {

            <span class="pl-smi">Permissions</span> permissions <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(readUserPermissions, user);
            <span class="pl-k">if</span> (<span class="pl-k">!</span>driver<span class="pl-k">.</span>execute(hasEditPermission, permissions)) {
                driver<span class="pl-k">.</span>execute(notifyPermissionsError);
            } <span class="pl-k">else</span> {
                <span class="pl-smi">String</span> userInput <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(promptUserForNewValue);
                <span class="pl-smi">Status</span> storeStatus <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(updateStoredValue, userInput);
                <span class="pl-k">if</span> (storeStatus <span class="pl-k">!=</span> <span class="pl-smi">Status</span><span class="pl-c1"><span class="pl-k">.</span>OK</span>) {
                    driver<span class="pl-k">.</span>execute(notifyStoreError);
                }
            }
        }
    });
}</pre></div>

<h2>
<a id="critical-rules-of-the-road" class="anchor" href="#critical-rules-of-the-road" aria-hidden="true"><span class="octicon octicon-link"></span></a>Critical Rules of the Road</h2>

<ul>
<li>
<strong>Wrap all reads/writes of non-local data in AsyncTasks/SyncTasks</strong>

<ul>
<li>...</li>
</ul>
</li>
<li>
<strong>Don't use try/catch in the AsyncDriver body</strong>

<ul>
<li>...</li>
</ul>
</li>
</ul>

<h3>
<a id="wrap-all-readswrites-of-non-local-data-in-asynctaskssynctasks" class="anchor" href="#wrap-all-readswrites-of-non-local-data-in-asynctaskssynctasks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Wrap all reads/writes of non-local data in AsyncTasks/SyncTasks</h3>

<p>Here is an example of what not to do (see comments):</p>

<div class="highlight highlight-source-java"><pre>        <span class="pl-k">final</span> <span class="pl-smi">JasyncDriver</span> driver <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JasyncDriver</span>();
        driver<span class="pl-k">.</span>execute(<span class="pl-k">new</span> <span class="pl-smi">DriverBody</span>() {
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>() {
                <span class="pl-smi">Permissions</span> permissions <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(readUserPermissions, user);
                <span class="pl-c">// ERROR: Accessing a class variable! (defined outside of the DriverBody method)</span>
                <span class="pl-c">// This needs to be wrapped in a SyncTask</span>
                <span class="pl-k">if</span> (updateServerValueCheckbox<span class="pl-k">.</span>isSet()) {
                    <span class="pl-c">// WARNING: This method may or may access external variables</span>
                    <span class="pl-c">// within. We can't tell from here, so it's safest to wrap</span>
                    <span class="pl-c">// it in a SyncTask to ensure that edits to the method body do</span>
                    <span class="pl-c">// not break the DriverBody.</span>
                    <span class="pl-k">if</span> (<span class="pl-k">!</span>hasEditPermission(permissions)) {
                        driver<span class="pl-k">.</span>execute(notifyPermissionsError);
                    } <span class="pl-k">else</span> {
                        <span class="pl-smi">String</span> userInput <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(promptUserForNewValue);
                        <span class="pl-smi">Status</span> storeStatus <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(updateStoredValue, userInput);
                        <span class="pl-k">if</span> (storeStatus <span class="pl-k">!=</span> <span class="pl-smi">Status</span><span class="pl-c1"><span class="pl-k">.</span>OK</span>) {
                            driver<span class="pl-k">.</span>execute(notifyStoreError);
                        }
                    }
                }
            }
        });</pre></div>

<p>jasync-driver can only function properly if all access to variables outside of the <strong>method scope</strong> is wrapped by
AsyncTask/SyncTask and executed by driver.execute(Task).</p>

<h3>
<a id="dont-use-trycatch-in-the-jasyncdriver-body" class="anchor" href="#dont-use-trycatch-in-the-jasyncdriver-body" aria-hidden="true"><span class="octicon octicon-link"></span></a>Don't use try/catch in the JasyncDriver body</h3>

<p>Never use try/catch blocks to cature exceptions escaping from AsyncTask/SyncTask. jasync-driver uses exceptions (Error)
to interrupt execution when waiting for a response from an asynchronus action, so they need to be able to leak
out of the DriverBody.</p>

<p>Here is an example of what not to do:</p>

<div class="highlight highlight-source-java"><pre>        <span class="pl-k">final</span> <span class="pl-smi">JasyncDriver</span> driver <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JasyncDriver</span>();
        driver<span class="pl-k">.</span>execute(<span class="pl-k">new</span> <span class="pl-smi">DriverBody</span>() {
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>() {
                <span class="pl-c">// ERROR: Do not use try/catch blocks within the DriveBody.</span>
                <span class="pl-c">// Instead, incorporate try/catch logic into the body of one or</span>
                <span class="pl-c">// more AsyncTask/SyncTax.</span>
                <span class="pl-k">try</span> {
                    driver<span class="pl-k">.</span>execute(readUserPermissions, user);
                } <span class="pl-k">catch</span> (<span class="pl-smi">Exception</span> e) {
                    driver<span class="pl-k">.</span>execute(notifyUserOfReadError);
                }
            }
        });</pre></div>

<p>Here's a fixed version of that code:</p>

<div class="highlight highlight-source-java"><pre>        <span class="pl-k">final</span> <span class="pl-smi">JasyncDriver</span> driver <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JasyncDriver</span>();
        driver<span class="pl-k">.</span>execute(<span class="pl-k">new</span> <span class="pl-smi">DriverBody</span>() {
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>() {
                <span class="pl-c">// NOTE: Now now exception handling here,</span>
                <span class="pl-c">// but instead it is inside of readUserPermissions</span>
                driver<span class="pl-k">.</span>execute(readUserPermissions, user);
                <span class="pl-k">if</span> (driver<span class="pl-k">.</span>execute(getLastRequestFailed)) {
                    driver<span class="pl-k">.</span>execute(notifyUserOfReadError);
                }
            }
        });</pre></div>

<p>And here's a more complete version of the fix, which shows the exception handling inside of the AsyncTask
(see comments):</p>

<div class="highlight highlight-source-java"><pre>    <span class="pl-smi">WebServer</span> webServer;
    <span class="pl-smi">UserInterface</span> userInterface;
    <span class="pl-smi">User</span> user;

    <span class="pl-k">public</span> <span class="pl-k">void</span> onUserClick() {

        <span class="pl-k">final</span> <span class="pl-smi">AtomicBoolean</span> lastRequestFailed <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">AtomicBoolean</span>(<span class="pl-c1">false</span>);

        <span class="pl-k">final</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">User</span>,<span class="pl-smi">Permissions</span>&gt;</span> readUserPermissions <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">User</span>,<span class="pl-smi">Permissions</span>&gt;</span>() {
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>(<span class="pl-k">final</span> <span class="pl-smi">User</span> <span class="pl-v">user</span>, <span class="pl-k">final</span> <span class="pl-k">ResultHandler&lt;<span class="pl-smi">Permissions</span>&gt;</span> <span class="pl-v">resultHandler</span>) {
                webServer<span class="pl-k">.</span>readUserPermissions(user, <span class="pl-k">new</span> <span class="pl-k">ReturnCallback&lt;<span class="pl-smi">Permissions</span>&gt;</span> () {
                    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">handleResult</span>(<span class="pl-smi">Permissions</span> <span class="pl-v">result</span>) {
                        <span class="pl-c">// Exception handling has been moved inside of this AsyncTask</span>
                        <span class="pl-k">try</span> {
                            resultHandler<span class="pl-k">.</span>reportComplete(result);
                        } <span class="pl-k">catch</span> (<span class="pl-smi">Exception</span> e) {
                            <span class="pl-c">// The exceptional result is stored in an external variable.</span>
                            <span class="pl-c">// That is fine because we're using AsyncTask/SyntTasks</span>
                            <span class="pl-c">// to access the variable.</span>
                            lastRequestFailed<span class="pl-k">.</span>set(<span class="pl-c1">true</span>);                            
                        }
                    }
                });
            }
        };

        <span class="pl-k">final</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Void</span>&gt;</span> notifyUserOfReadError <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Void</span>&gt;</span>() {
            <span class="pl-k">public</span> <span class="pl-smi">Void</span> <span class="pl-en">run</span>(<span class="pl-smi">Void</span> <span class="pl-v">arg</span>) {
                userInterface<span class="pl-k">.</span>showError(<span class="pl-s"><span class="pl-pds">"</span>Failed to read from server<span class="pl-pds">"</span></span>);
                <span class="pl-k">return</span> <span class="pl-c1">null</span>;
            }
        };

        <span class="pl-k">final</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Boolean</span>&gt;</span> getLastRequestFailed <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Boolean</span>&gt;</span>() {
            <span class="pl-k">public</span> <span class="pl-smi">Boolean</span> <span class="pl-en">run</span>(<span class="pl-smi">Void</span> <span class="pl-v">arg</span>) {
                <span class="pl-k">return</span> lastRequestFailed<span class="pl-k">.</span>get();
            }
        };

        <span class="pl-k">final</span> <span class="pl-smi">JasyncDriver</span> driver <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JasyncDriver</span>();
        driver<span class="pl-k">.</span>execute(<span class="pl-k">new</span> <span class="pl-smi">DriverBody</span>() {
            <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>() {
                <span class="pl-c">// NOTE: Now now exception handling here,</span>
                <span class="pl-c">// but instead it is inside of readUserPermissions</span>
                driver<span class="pl-k">.</span>execute(readUserPermissions, user);
                <span class="pl-k">if</span> (driver<span class="pl-k">.</span>execute(getLastRequestFailed)) {
                    driver<span class="pl-k">.</span>execute(notifyUserOfReadError);
                }
            }
        });
    }</pre></div>

<h2>
<a id="how-it-works" class="anchor" href="#how-it-works" aria-hidden="true"><span class="octicon octicon-link"></span></a>How it Works</h2>

<p>Here is the the basic internal execution of jasync-executor:</p>

<ul>
<li>JasyncDriver launches the DriverBody method</li>
<li>When the DriverBody hits an AsyncTask:

<ul>
<li>JasyncDriver launches the asynchronous action with a callback to wake up JasyncDriver on return</li>
<li>JasyncDriver throws an Exception (Error) to quickly terminate the DriverBody</li>
</ul>
</li>
<li>Eventually the asynchronous action's callback wakes up JasyncDriver</li>
<li>JasyncDriver caches any value returned by the asynchronous action</li>
<li>JasyncDriver launches the DriverBody method</li>
<li>When the DriverBody hits the same AsyncTask, it simply uses the cached return value instead of executing it again</li>
<li>(the same process is repeated for each AsyncTask until the DriverBody exists cleanly)</li>
</ul>

<p>The net effect is that thet DriverBody is potentially run many, many times,
but the AsyncTasks/SyncTasks are each run only once (or run as many times as they appear in the DriverBody--they can be reused).</p>

<p>Here is a modified code example that includes logging to demonstration order of execution:</p>

<blockquote>
<p>Note that this is also prime example of why you cannot access external variables within a DriverBody without an AsyncTask/SyncTask wrapper.
System.out.printf() is being called many more times than a developer would first expect.</p>

<p>However, in this particular case we're using these log messages to demonstrate the actual exeuction order of things.</p>
</blockquote>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">void</span> onUserClick() {

    <span class="pl-k">final</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">User</span>,<span class="pl-smi">Permissions</span>&gt;</span> readUserPermissions <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">User</span>,<span class="pl-smi">Permissions</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>(<span class="pl-k">final</span> <span class="pl-smi">User</span> <span class="pl-v">user</span>, <span class="pl-k">final</span> <span class="pl-k">ResultHandler&lt;<span class="pl-smi">Permissions</span>&gt;</span> <span class="pl-v">resultHandler</span>) {
            webServer<span class="pl-k">.</span>readUserPermissions(user, <span class="pl-k">new</span> <span class="pl-k">ReturnCallback&lt;<span class="pl-smi">Permissions</span>&gt;</span> () {
                <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">handleResult</span>(<span class="pl-smi">Permissions</span> <span class="pl-v">result</span>) {
                    <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>== Executing [readUserPermissions] ==<span class="pl-pds">"</span></span>);
                    resultHandler<span class="pl-k">.</span>reportComplete(result);
                }
            });
        }
    };

    <span class="pl-k">final</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Permissions</span>,<span class="pl-smi">Boolean</span>&gt;</span> hasEditPermission <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Permissions</span>,<span class="pl-smi">Boolean</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-smi">Boolean</span> <span class="pl-en">run</span>(<span class="pl-smi">Permissions</span> <span class="pl-v">permissions</span>) {
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>== Executing [hasEditPermission] ==<span class="pl-pds">"</span></span>);
            <span class="pl-k">return</span> permissions<span class="pl-k">.</span>toString()<span class="pl-k">.</span>contains(<span class="pl-s"><span class="pl-pds">"</span>edit<span class="pl-pds">"</span></span>);
        }
    };

    <span class="pl-k">final</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Void</span>&gt;</span> notifyPermissionsError <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Void</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-smi">Void</span> <span class="pl-en">run</span>(<span class="pl-smi">Void</span> <span class="pl-v">arg</span>) {
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>== Executing [notifyPermissionsError] ==<span class="pl-pds">"</span></span>);
            userInterface<span class="pl-k">.</span>showError(<span class="pl-s"><span class="pl-pds">"</span>User does not have edit permission<span class="pl-pds">"</span></span>);
            <span class="pl-k">return</span> <span class="pl-c1">null</span>;
        }
    };

    <span class="pl-k">final</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">String</span>&gt;</span> promptUserForNewValue <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">String</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>(<span class="pl-k">final</span> <span class="pl-smi">Void</span>  <span class="pl-v">arg</span>, <span class="pl-k">final</span> <span class="pl-k">ResultHandler&lt;<span class="pl-smi">String</span>&gt;</span> <span class="pl-v">resultHandler</span>) {
            userInterface<span class="pl-k">.</span>promptForNewValue(<span class="pl-k">new</span> <span class="pl-k">ReturnCallback&lt;<span class="pl-smi">String</span>&gt;</span> () {
                <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">handleResult</span>(<span class="pl-smi">String</span> <span class="pl-v">result</span>) {
                    <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>== Executing [promptUserForNewValue] ==<span class="pl-pds">"</span></span>);
                    resultHandler<span class="pl-k">.</span>reportComplete(result);
                }
            });
        }
    };

    <span class="pl-k">final</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">String</span>,<span class="pl-smi">Status</span>&gt;</span> updateStoredValue <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">AsyncTask&lt;<span class="pl-smi">String</span>,<span class="pl-smi">Status</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>(<span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-v">value</span>, <span class="pl-k">final</span> <span class="pl-k">ResultHandler&lt;<span class="pl-smi">Status</span>&gt;</span> <span class="pl-v">resultHandler</span>) {
            webServer<span class="pl-k">.</span>storeValue(value, <span class="pl-k">new</span> <span class="pl-k">ReturnCallback&lt;<span class="pl-smi">Status</span>&gt;</span> () {
                <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">handleResult</span>(<span class="pl-smi">Status</span> <span class="pl-v">result</span>) {
                    <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>== Executing [updateStoredValue] ==<span class="pl-pds">"</span></span>);
                    resultHandler<span class="pl-k">.</span>reportComplete(result);
                }
            });
        }
    };

    <span class="pl-k">final</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Void</span>&gt;</span> notifyStoreError <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">SyncTask&lt;<span class="pl-smi">Void</span>,<span class="pl-smi">Void</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-smi">Void</span> <span class="pl-en">run</span>(<span class="pl-smi">Void</span> <span class="pl-v">arg</span>) {
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>== Executing [notifyStoreError]  ==<span class="pl-pds">"</span></span>);
            userInterface<span class="pl-k">.</span>showError(<span class="pl-s"><span class="pl-pds">"</span>Store action failed!<span class="pl-pds">"</span></span>);
            <span class="pl-k">return</span> <span class="pl-c1">null</span>;
        }
    };

    <span class="pl-k">final</span> <span class="pl-smi">JasyncDriver</span> driver <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">JasyncDriver</span>();
    driver<span class="pl-k">.</span>execute(<span class="pl-k">new</span> <span class="pl-smi">DriverBody</span>() {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">run</span>() {
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>printf(<span class="pl-s"><span class="pl-pds">"</span>Launching DriverBody%n<span class="pl-pds">"</span></span>);
            <span class="pl-smi">Permissions</span> permissions <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(readUserPermissions, user);
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>printf(<span class="pl-s"><span class="pl-pds">"</span>Value of permissions: %s%n<span class="pl-pds">"</span></span>, permissions);
            <span class="pl-smi">Boolean</span> hasPermission <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(hasEditPermission, permissions);
            <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>printf(<span class="pl-s"><span class="pl-pds">"</span>Value of hasPermission: %s%n<span class="pl-pds">"</span></span>, hasPermission);
            <span class="pl-k">if</span> (<span class="pl-k">!</span>hasPermission) {
                driver<span class="pl-k">.</span>execute(notifyPermissionsError);
            } <span class="pl-k">else</span> {
                <span class="pl-smi">String</span> userInput <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(promptUserForNewValue);
                <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>printf(<span class="pl-s"><span class="pl-pds">"</span>Value of userInput: %s%n<span class="pl-pds">"</span></span>, userInput);
                <span class="pl-smi">Status</span> storeStatus <span class="pl-k">=</span> driver<span class="pl-k">.</span>execute(updateStoredValue, userInput);
                <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>printf(<span class="pl-s"><span class="pl-pds">"</span>Value of storeStatus: %s%n<span class="pl-pds">"</span></span>, storeStatus);
                <span class="pl-k">if</span> (storeStatus <span class="pl-k">!=</span> <span class="pl-smi">Status</span><span class="pl-c1"><span class="pl-k">.</span>OK</span>) {
                    driver<span class="pl-k">.</span>execute(notifyStoreError);
                }
            }
        }
    });
}</pre></div>

<p>And here's the resulting output of the sample code:</p>

<pre><code>Launching DriverBody
== Executing [readUserPermissions] ==
Launching DriverBody
Value of permissions: view,edit
== Executing [hasEditPermission] ==
Value of hasPermission: true
== Executing [promptUserForNewValue] ==
Launching DriverBody
Value of permissions: view,edit
Value of hasPermission: true
Value of userInput: foobar
== Executing [updateStoredValue] ==
Launching DriverBody
Value of permissions: view,edit
Value of hasPermission: true
Value of userInput: foobar
Value of storeStatus: FAILURE
== Executing [notifyStoreError]  ==
</code></pre>

<h2>
<a id="faq" class="anchor" href="#faq" aria-hidden="true"><span class="octicon octicon-link"></span></a>FAQ</h2>

<h3>
<a id="can-you-reuse-the-same-asyntasksynctask-multiple-times-within-the-same-driverbody" class="anchor" href="#can-you-reuse-the-same-asyntasksynctask-multiple-times-within-the-same-driverbody" aria-hidden="true"><span class="octicon octicon-link"></span></a>Can you reuse the same AsynTask/SyncTask multiple times within the same DriverBody?</h3>

<p>Yes! jasync-driver caches the result of each Task by execution location,
so it is safe to use the same Task multiple times in the same DriverBody definition.</p>

<h3>
<a id="can-you-reuse-a-driverbody-instance" class="anchor" href="#can-you-reuse-a-driverbody-instance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Can you reuse a DriverBody instance?</h3>

<p>Yes. The DriverBody retains no state of it's own.</p>

<h3>
<a id="can-you-reuse-a-jasyncdriver-instance" class="anchor" href="#can-you-reuse-a-jasyncdriver-instance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Can you reuse a JasyncDriver instance?</h3>

<p>Yes. The JasyncDriver resets internal state when the DriverBody terminates cleanly.</p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
